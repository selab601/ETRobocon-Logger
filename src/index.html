<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ET2016 EV3 Logger</title>

    <style>
      .axis path,
      .axis line {
        fill: none;
        stroke: black;
        shape-rendering: crispEdges;
      }

      .axis text {
        font-family: sans-serif;
        font-size: 11px;
      }
    </style>

    <!-- ライブラリのロード -->
    <script>
      window.jQuery = window.$ = require('./js/lib/jquery-3.1.0.min.js');
      var d3 = require('./js/lib/d3.min.js');
    </script>

    <script>
      var initialized = false;
      var stage;
      var stageHeight = 400;
      var stageWidth = 700;
      var padding = 20;
      var points = new Array();

      var xScale = d3.scale.linear()
                     .range([padding, stageWidth - padding]);
      var xAxis = d3.svg.axis()
                    .orient('bottom');
      var yScale = d3.scale.linear()
                     .range([stageHeight - padding, padding])
      var yAxis = d3.svg.axis()
                    .orient('left');
      var xShift = 0;
      var line = d3.svg.line()
                   .x(function(d,i){return xScale(i+xShift);})
                   .y(function(d,i){return yScale(d.color.brightness);})
                   .interpolate("linear");

      // DOM の準備ができたら描画する
      $(document).ready(function() {
        // SVG要素をDOMに追加
        stage = d3
          .select("#d3graph")
          .append("svg")
          .attr('class', 'chart')
          .attr("width", stageWidth)
          .attr("height", stageHeight);

        initialized = true;
      });

      // EV3 から格値を受け取る
      var ipcRenderer = require('electron').ipcRenderer;
      ipcRenderer.on('serial', (ev, message) => {
        var obj = JSON.parse(message);

        if (initialized) {
          var maxXData = 100;
          var minXData = 0;
          var maxYData = 80;
          var minYData = 0;

          // データの更新
          points.push(obj);
          if(points.length > maxXData) {
            points.shift();
            xShift++;
          }

          // グラフの再描画
          stage.selectAll("path").remove();
          stage.append("path")
               .attr("d", line(points))
               .attr("stroke", "steelblue")
               .attr("fill", "none");

          // ラベルの再描画
          stage.selectAll("text").remove();
          stage.selectAll("text")
               .data(points)
               .enter()
               .append("text")
               .text(function(d) { return d.color.brightness; })
               .attr("x", function(d, i) {
                 return padding + ((stageWidth - padding*2)/100) * i;
               })
               .attr("y", function(d) {
                 return padding + (stageHeight-padding*2) - ((stageHeight-padding*2)/maxYData) * d.color.brightness;
               })
               .attr("font-family", "sans-serif")
               .attr("font-size", "11px")
               .attr("fill", "black");

          // 軸の再描画
          stage.selectAll("g").remove();
          stage.append('g')
               .attr("class", "axis")
               .attr("transform", "translate(0," + (stageHeight - padding) + ")")
               .call(xAxis.scale(xScale.domain([xShift + minXData, xShift + maxXData])));
          stage.append('g')
               .attr("class", "axis")
               .attr("transform", "translate(" + padding + ",0)")
               .call(yAxis.scale(yScale.domain([minYData, maxYData])));
        };
      });
    </script>
  </head>
  <body>
    <div id="d3graph"></div>
  </body>
</html>
