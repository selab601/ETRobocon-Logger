<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ET2016 EV3 Logger</title>

    <!-- ライブラリのロード -->
    <script>
      window.jQuery = window.$ = require('./js/lib/jquery-3.1.0.min.js');
      var d3 = require('./js/lib/d3.min.js');
    </script>

    <script>
      var initialized = false;
      var stage;
      var stage_height = 300;
      var stage_width = 300;
      var d3line;
      var points = new Array();

      // DOM の準備ができたら描画する
      $(document).ready(function() {
        // SVG要素をDOMに追加
        stage = d3
          .select("#d3graph")
          .append("svg")
          .attr("width", stage_width)
          .attr("height", stage_height);
        // ラインを生成するための関数を用意
        d3line = d3.svg.line()
          .x(function(d,i){return i;})
          .y(function(d,i){return d.color.brightness;})
          .interpolate("linear");

        initialized = true;
      });

      // EV3 から格値を受け取る
      var ipcRenderer = require('electron').ipcRenderer;
      ipcRenderer.on('serial', (ev, message) => {
        var obj = JSON.parse(message);

        if (initialized) {
          points.push(obj);

          if(points.length > $("#d3graph").width()/10) {
            points.shift();
          }

          // 削除する
          stage.selectAll("path").remove();

          // 描画する
          stage.append("path")
               .attr("d", d3line(points))
               .attr("stroke", "steelblue")
               .attr("fill", "none");
        }
      });
    </script>
  </head>
  <body>
    <div id="d3graph" style="border:1px solid #ccc; margin-bottom:10px"></div>
  </body>
</html>
